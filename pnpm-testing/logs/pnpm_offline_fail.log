============================================================
PNPM Snapshotting Bug Reproduction Test
============================================================

1. Looking up/creating Modal app...
2. Creating sandbox with Docker-in-gvisor enabled...
   Sandbox created in 0.78s

3. Waiting for Docker daemon to initialize...
4. Verifying Docker daemon status...
   Docker status: Running

5. Checking Slidev repository structure...
   Repository contents:
   total 476
drwxr-xr-x 1 root root   4096 Sep  2 17:43 .
drwxr-xr-x 1 root root     20 Sep  2 17:43 ..
drwxr-xr-x 1 root root   4096 Sep  2 17:43 .git
drwxr-xr-x 1 root root    101 Sep  2 17:43 .github
-rw-r--r-- 1 root root    446 Sep  2 17:43 .gitignore
-rw-r--r-- 1 root root    548 Sep  2 17:43 .gitpod.yml
-rw-r--r-- 1 root root    115 Sep  2 17:43 .npmrc
drwxr-xr-x 1 root root     85 Sep  2 17:43 .vscode
-rw-r--r-- 1 root root   5216 Sep  2 17:43 CODE_OF_CONDUCT.md
-rw-r--r-- 1 root root   2765 Sep  2 17:43 CONTRIBUTING.md
-rw-r--r-- 1 root root   1075 Sep  2 17:43 LICENSE
-rw-r--r-- 1 root root   5429 Sep  2 17:43 README.md
drwxr-xr-x 1 root root   4096 Sep  2 17:43 assets
drwxr-xr-x 1 root root     70 Sep  2 17:43 cypress
-rw-r--r-- 1 root root    223 Sep  2 17:43 cypress.config.ts
drwxr-xr-x 1 root root     98 Sep  2 17:43 demo
drwxr-xr-x 1 root root   4096 Sep  2 17:43 docs
-rw-r--r-- 1 root root    663 Sep  2 17:43 eslint.config.js
-rwxr-xr-x 1 root root    748 Sep  2 17:43 netlify.toml
-rw-r--r-- 1 root root   2924 Sep  2 17:43 package.json
drwxr-xr-x 1 root root    145 Sep  2 17:43 packages
drwxr-xr-x 1 root root     64 Sep  2 17:43 patches
-rw-r--r-- 1 root root 429959 Sep  2 17:43 pnpm-lock.yaml
-rw-r--r-- 1 root root   4199 Sep  2 17:43 pnpm-workspace.yaml
drwxr-xr-x 1 root root    168 Sep  2 17:43 scripts
-rw-r--r-- 1 root root   1091 Sep  2 17:43 shim.d.ts
-rw-r--r-- 1 root root    241 Sep  2 17:43 taze.config.ts
drwxr-xr-x 1 root root   4096 Sep  2 17:43 test
-rw-r--r-- 1 root root   1254 Sep  2 17:43 tsconfig.json
-rw-r--r-- 1 root root    198 Sep  2 17:43 tsdown.config.ts

6. Analyzing package.json files...
   Found 1 package.json files

7. Running pnpm install...
   Scope: all 13 workspace projects
   Lockfile is up to date, resolution step is skipped
   Progress: resolved 1, reused 0, downloaded 0, added 0
   Packages: +1303
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   Progress: resolved 1303, reused 0, downloaded 171, added 169
   Progress: resolved 1303, reused 0, downloaded 388, added 383
   Progress: resolved 1303, reused 0, downloaded 593, added 591
   Progress: resolved 1303, reused 0, downloaded 820, added 753
   Progress: resolved 1303, reused 0, downloaded 983, added 943
   Progress: resolved 1303, reused 0, downloaded 1197, added 1152
   Progress: resolved 1303, reused 0, downloaded 1301, added 1302
   Progress: resolved 1303, reused 0, downloaded 1302, added 1302
   Progress: resolved 1303, reused 0, downloaded 1302, added 1303, done
   .../typeit@8.1.0/node_modules/typeit postinstall$ node ./scripts/notice.js
   .../cypress@14.5.3/node_modules/cypress postinstall$ node index.js --exec install
.../esbuild@0.25.0/node_modules/esbuild postinstall$ node install.js
.../node_modules/simple-git-hooks postinstall$ node ./postinstall.js
   .../node_modules/playwright-chromium install$ node install.js
   .../typeit@8.1.0/node_modules/typeit postinstall: [35mThanks for using TypeIt! If you're using this library commercially, please purchase a license:
.../typeit@8.1.0/node_modules/typeit postinstall: https://typeitjs.com/licenses/purchase[0m
.../typeit@8.1.0/node_modules/typeit postinstall: Done
   .../node_modules/@vscode/vsce-sign postinstall$ node ./src/postinstall.js
   .../esbuild@0.25.0/node_modules/esbuild postinstall: Done
   .../node_modules/simple-git-hooks postinstall: [INFO] Successfully set the pre-commit with command: npx lint-staged
   pnpm install completed successfully in 47.85s
   Total output lines: 292

8. Checking installed packages...
   0	/workspace/slidev/packages/create-app/node_modules
26K	/workspace/slidev/packages/slidev/node_modules
1.0K	/workspace/slidev/packages/types/node_modules
4.0K	/workspace/slidev/packages/vscode/node_modules
6.5K	/workspace/slidev/docs/node_modules
   Total packages installed: 1445

9. Recording node_modules snapshot before suspend...
   {"package_json_count": 1445, "top_entries_sample": [".bin", ".modules.yaml", ".pnpm", ".pnpm-workspace-state-v1.json", "@ampproject"], "pnpm_entries_sample": ["@ampproject+remapping@2.3.0", "@antfu+eslint-config@5.0.0_@vue+compiler-sfc@3.5.18_eslint-plugin-format@1.0.1_eslint@9_dbbe0473442cb313e0559c3ea9accd11", "@antfu+install-pkg@1.1.0", "@antfu+ni@24.4.0", "@antfu+ni@25.0.0"], "sample_package_paths": [], "top_entry_count": 924, "pnpm_entry_count": 1304}

10. Checking python3 availability inside sandbox...
   python3 reports: Python 3.11.2

11. Attempting to create filesystem snapshot (simulated suspend)...
   SUCCESS: Snapshot created in 20.47s
   Snapshot image: Image()

12. Terminating original sandbox before resume...
    Original sandbox terminated

13. Creating resumed sandbox from snapshot image...
   Resumed sandbox ready in 0.04s

14. Validating node_modules snapshot after resume...
   top_count=920
   pnpm_count=1304

14b. Attempting pnpm install --offline inside resumed sandbox...
   Scope: all 13 workspace projects
   Lockfile is up to date, resolution step is skipped
   Already up to date
   ENOENTâ€‰ ENOENT: no such file or directory, open '/workspace/slidev/node_modules/.pnpm/vite@7.0.6_@types+node@24.1.0_jiti@2.5.1_lightningcss@1.30.1_tsx@4.20.3_yaml@2.8.0/node_modules/vite/package.json'

pnpm: ENOENT: no such file or directory, open '/workspace/slidev/node_modules/.pnpm/vite@7.0.6_@types+node@24.1.0_jiti@2.5.1_lightningcss@1.30.1_tsx@4.20.3_yaml@2.8.0/node_modules/vite/package.json'
   WARNâ€‰ Failed to create bin at /workspace/slidev/node_modules/.pnpm/tsx@4.20.3/node_modules/tsx/node_modules/.bin/esbuild. ENOENT: no such file or directory, open '/workspace/slidev/node_modules/.pnpm/tsx@4.20.3/node_modules/esbuild/bin/esbuild'
â€‰WARNâ€‰ Failed to create bin at /workspace/slidev/node_modules/.pnpm/vite@7.0.6_@types+node@24.1.0_jiti@2.5.1_lightningcss@1.30.1_tsx@4.20.3_yaml@2.8.0/node_modules/vite/node_modules/.bin/esbuild. ENOENT: no such file or directory, open '/workspace/slidev/node_modules/.pnpm/vite@7.0.6_@types+node@24.1.0_jiti@2.5.1_lightningcss@1.30.1_tsx@4.20.3_yaml@2.8.0/node_modules/esbuild/bin/esbuild'
   pnpm install --offline FAILED (this indicates missing modules after resume).

15. Terminating resumed sandbox...
    Resumed sandbox terminated

============================================================
TEST SUMMARY
============================================================
Repository: Slidev (presentation framework)
Package manager: pnpm
Packages installed: 1445
Install duration: 47.85s
Snapshot attempt: SUCCESS
Snapshot duration: 20.47s
Package.json count before suspend: 1445
Top-level entries sample before suspend: .bin, .modules.yaml, .pnpm, .pnpm-workspace-state-v1.json, @ampproject
Tracked top entries present after resume: 5 / 5
Tracked .pnpm entries present after resume: 5 / 5
Tracked package.json samples present after resume: 0 / 0
Top-level entry count after resume: 920 (expected 924)
.pnpm entry count after resume: 1304 (expected 1304)
Node_modules validation: FAIL
============================================================
